# Custom Redis provisioner for Kubernetes

- uri: template://custom/redis
  type: redis
  resources: |
    apiVersion: v1
    kind: Secret
    metadata:
      name: ${.WorkloadName}-redis-secret
    type: Opaque
    stringData:
      password: ${.State.password}
    ---
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: ${.WorkloadName}-redis
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: ${.WorkloadName}-redis
      template:
        metadata:
          labels:
            app: ${.WorkloadName}-redis
        spec:
          containers:
            - name: redis
              image: redis:7-alpine
              command:
                - redis-server
                {{- if .State.password }}
                - --requirepass
                - $(REDIS_PASSWORD)
                {{- end }}
              ports:
                - containerPort: 6379
                  name: redis
              env:
                {{- if .State.password }}
                - name: REDIS_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: ${.WorkloadName}-redis-secret
                      key: password
                {{- end }}
              livenessProbe:
                exec:
                  command:
                    - redis-cli
                    - ping
                initialDelaySeconds: 30
                periodSeconds: 10
              readinessProbe:
                exec:
                  command:
                    - redis-cli
                    - ping
                initialDelaySeconds: 5
                periodSeconds: 5
    ---
    apiVersion: v1
    kind: Service
    metadata:
      name: ${.WorkloadName}-redis
    spec:
      selector:
        app: ${.WorkloadName}-redis
      ports:
        - port: 6379
          targetPort: 6379
          name: redis
  
  state: |
    host: ${.WorkloadName}-redis
    port: "${.Params.port | default 6379}"
    password: ${.Params.password | default ""}
    database: "${.Params.database | default 0}"
  
  outputs: |
    host: ${.State.host}
    port: ${.State.port}
    password: ${.State.password}
    database: ${.State.database}
