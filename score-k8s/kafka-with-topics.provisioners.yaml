# Custom Kafka provisioner with automatic topic creation for Kubernetes
# This provisioner creates Kafka StatefulSet and runs topic creation via InitContainer

- uri: template://custom/kafka-with-topics
  type: kafka-with-topics
  resources: |
    apiVersion: v1
    kind: Service
    metadata:
      name: ${.WorkloadName}-zookeeper
    spec:
      ports:
        - port: 2181
          name: zookeeper
      selector:
        app: ${.WorkloadName}-zookeeper
    ---
    apiVersion: apps/v1
    kind: StatefulSet
    metadata:
      name: ${.WorkloadName}-zookeeper
    spec:
      serviceName: ${.WorkloadName}-zookeeper
      replicas: 1
      selector:
        matchLabels:
          app: ${.WorkloadName}-zookeeper
      template:
        metadata:
          labels:
            app: ${.WorkloadName}-zookeeper
        spec:
          containers:
            - name: zookeeper
              image: confluentinc/cp-zookeeper:latest
              ports:
                - containerPort: 2181
                  name: zookeeper
              env:
                - name: ZOOKEEPER_CLIENT_PORT
                  value: "2181"
                - name: ZOOKEEPER_TICK_TIME
                  value: "2000"
    ---
    apiVersion: v1
    kind: Service
    metadata:
      name: ${.WorkloadName}-kafka
    spec:
      ports:
        - port: 9092
          name: kafka
      selector:
        app: ${.WorkloadName}-kafka
    ---
    apiVersion: apps/v1
    kind: StatefulSet
    metadata:
      name: ${.WorkloadName}-kafka
    spec:
      serviceName: ${.WorkloadName}-kafka
      replicas: 1
      selector:
        matchLabels:
          app: ${.WorkloadName}-kafka
      template:
        metadata:
          labels:
            app: ${.WorkloadName}-kafka
        spec:
          initContainers:
            - name: kafka-init
              image: confluentinc/cp-kafka:latest
              command:
                - /bin/sh
                - -c
                - |
                  echo 'Waiting for Kafka to be ready...'
                  until kafka-broker-api-versions --bootstrap-server ${.WorkloadName}-kafka:9092 &>/dev/null; do
                    sleep 1
                  done
                  echo 'Kafka is ready!'
                  {{- range $key, $topic := .State.topics }}
                  kafka-topics --create --if-not-exists --bootstrap-server ${.WorkloadName}-kafka:9092 --topic {{ $topic }} --partitions {{ $.State.topicConfig.partitions | default 3 }} --replication-factor {{ $.State.topicConfig.replicationFactor | default 1 }}
                  {{- end }}
                  echo 'All Kafka topics created!'
          containers:
            - name: kafka
              image: confluentinc/cp-kafka:latest
              ports:
                - containerPort: 9092
                  name: kafka
              env:
                - name: KAFKA_BROKER_ID
                  value: "1"
                - name: KAFKA_ZOOKEEPER_CONNECT
                  value: "${.WorkloadName}-zookeeper:2181"
                - name: KAFKA_ADVERTISED_LISTENERS
                  value: "PLAINTEXT://${.WorkloadName}-kafka:9092"
                - name: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR
                  value: "1"
                - name: KAFKA_AUTO_CREATE_TOPICS_ENABLE
                  value: "false"
              livenessProbe:
                exec:
                  command:
                    - kafka-broker-api-versions
                    - --bootstrap-server
                    - localhost:9092
                initialDelaySeconds: 30
                periodSeconds: 10
  
  state: |
    brokers: ${.Params.brokers | default "${.WorkloadName}-kafka:9092"}
    topics: ${.Params.topics | default {}}
    topicConfig:
      partitions: ${.Params.topicConfig.partitions | default 3}
      replicationFactor: ${.Params.topicConfig.replicationFactor | default 1}
  
  outputs: |
    brokers: ${.State.brokers}
    topics: ${.State.topics}
